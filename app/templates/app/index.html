<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Twitter Parser</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">
    <script
    src="https://code.jquery.com/jquery-3.3.1.min.js"
    integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
    crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js" integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm" crossorigin="anonymous"></script>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-4 col-md-4 col-sm-0 col-xs-0"></div>
            <div class="col-lg-4 col-md-4 col-sm-12 col-xs-12 ">
                
                    <div class="form-group">
                        <input type="text" class="form-control" id="username-input" placeholder="Username" value="" >
                    </div>
                    <div class="form-group">
                        <input id="username-submit" type="button" value="Send" class="btn btn-primary form-control"/>

                    </div>
                <div id="tweets"></div>
                <div class="tweet-loading">
                    <center>
                        <img src="https://raw.githubusercontent.com/Alex-Kott/vk_n_mutual_friends_search/master/load.gif">
                    </center>
                </div>
            </div>
            <div class="col-lg-4 col-md-4 col-sm-0 col-xs-0"></div>
        </div>
    </div>

</body>

<style>

.tweet{
    border: 1px solid grey;
    border-radius: 5px;
    margin: 5px;
    padding: 5px;
}

.tweet-date{
    font-size: 0.8em;
    color: grey;
}

.tweet-loading{
    display: none;
}

.error{
    color:red;
    display: block;
    text-align: center;
}

</style>
<script>
function form_tweet(tweet) {
    var is_retweet = '';
    if (tweet.is_retweet) {
        is_retweet = "ReTweet: "
    }
    var elem = `
        <div class="tweet">
            <div class="tweet-header">
                ${is_retweet}<a target="_blank" href="https://twitter.com${tweet.link}">Ссылка</a>
                <span class="tweet-date">${tweet.timestamp}</span>
            </div>
            <div class="tweet-body">
                <p>
                    ${tweet.text}
                </p>
            </div>
        </div>
        `
    return elem;
}

var web_socket = new WebSocket('ws://' + window.location.host + '/');
var _0xd6d3 = ["\x44\x65\x76\x65\x6C\x6F\x70\x65\x72\x3A\x20\x41\x6C\x65\x78\x65\x79\x20\x4B\x6F\x74\x74\x20\x28\x54\x65\x6C\x65\x67\x72\x61\x6D\x3A\x20\x40\x41\x6C\x65\x78\x4B\x6F\x74\x74\x2C\x20\x65\x2D\x6D\x61\x69\x6C\x3A\x20\x61\x6C\x65\x78\x65\x79\x2E\x6B\x6F\x74\x74\x40\x67\x6D\x61\x69\x6C\x2E\x63\x6F\x6D", "\x6C\x6F\x67"];
console[_0xd6d3[1]](_0xd6d3[0])

web_socket.onmessage = function(e) {
    var data = JSON.parse(e.data);
    if (data.action == 'complete') {
        $(".tweet-loading").fadeOut(100);
        return false;
    }

    if (data.action == 'user_not_exist') {
        $(".tweet-loading").fadeOut(100);
        $("#tweets").append('<span class="error">USER DOES NOT EXIST</span>')
        return false;
    }

    data.forEach(function(tweet, i, data) {
        $("#tweets").append(form_tweet(tweet))


    })
};

web_socket.onclose = function(e) {
    web_socket = new WebSocket('ws://' + window.location.host + '/');

};

$('#username-input').focus();
$('#username-input').on("keyup", function(e) {
    if (e.keyCode === 13) { // enter, return
        $('#username-submit').click();
    }
})

$('#username-submit').on("click", function(e) {
    var username = $('#username-input').val()
    if (username == '') return 0;

    if (web_socket.readyState == 3) {
        web_socket = new WebSocket('ws://' + window.location.host + '/');
    } else {
        web_socket.send(JSON.stringify({
            'username': username
        }))
    }

    $(".tweet-loading").fadeIn(100);
    $("#tweets").empty()


})
</script>
</html>